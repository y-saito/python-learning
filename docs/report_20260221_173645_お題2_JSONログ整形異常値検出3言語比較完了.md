# 作業報告書

- 作成日時: 2026-02-21 17:36:45
- 対象プロジェクト: `python-learning`
- 報告範囲: お題2（JSONログ整形・欠損補完・外れ値検出）の実装・比較・検証

## 1. 実施サマリ

同一の JSON Lines 入力 (`data/api_logs_sample.jsonl`) に対して、`Python` / `Node.js` / `PHP` の 3 実装を作成した。
各実装は共通 CLI I/F（`--input <jsonl_path>`）で動作し、同一 JSON スキーマ（`summary`, `response_time_bounds`, `cleaned_logs`, `outliers`）を出力する。

## 2. 追加・更新ファイル

1. データ定義
- `data/api_logs_sample.jsonl`
  - 比較用の固定サンプルログ（欠損値・文字列数値・外れ値候補を含む）を追加。
- `data/api_logs_expected.json`
  - 期待値（正解出力）を追加。

2. Python 実装（基準）
- `app/data_processing/log_preprocessing.py`
  - `pandas.json_normalize()` + `to_datetime()` + `to_numeric()` + IQR で整形・異常値判定を実装。

3. Node.js 比較実装
- `comparisons/topic2/log_preprocessing_node.js`
  - JSONL を手続き的に整形し、線形補間分位点 + IQR で同等処理を実装。

4. PHP 比較実装
- `comparisons/topic2/log_preprocessing_php.php`
  - `json_decode` + 配列処理で整形し、線形補間分位点 + IQR で同等処理を実装。

5. ドキュメント更新
- `README.md`
  - お題2の実行コマンドと期待値比較コマンドを追記。

## 3. 共通仕様（I/F）

- 入力: `--input data/api_logs_sample.jsonl`
- 出力キー:
  - `summary`
  - `response_time_bounds`
  - `cleaned_logs`
  - `outliers`
- 欠損補完ルール:
  - `response_time_ms`: 中央値で補完
  - `status`: `0` で補完
  - `endpoint`: `"/unknown"` で補完
  - `method`: `"UNKNOWN"` で補完
- 外れ値判定ルール:
  - IQR 法（`[Q1 - 1.5*IQR, Q3 + 1.5*IQR]` の外側を外れ値）

## 4. 実行コマンド（Docker 経由）

1. Python
```bash
docker compose run --rm --no-deps app python -m app.data_processing.log_preprocessing --input data/api_logs_sample.jsonl
```

2. Node.js
```bash
docker run --rm -v "$PWD":/workspace -w /workspace node:20 node comparisons/topic2/log_preprocessing_node.js --input data/api_logs_sample.jsonl
```

3. PHP
```bash
docker run --rm -v "$PWD":/workspace -w /workspace php:8.3-cli php comparisons/topic2/log_preprocessing_php.php --input data/api_logs_sample.jsonl
```

4. 一致検証
```bash
diff -u <(jq -S . data/api_logs_expected.json) <(jq -S . /tmp/logs_py.json)
diff -u <(jq -S . data/api_logs_expected.json) <(jq -S . /tmp/logs_node.json)
diff -u <(jq -S . data/api_logs_expected.json) <(jq -S . /tmp/logs_php.json)
```
すべて差分なし（exit code 0）。

## 5. 行程別比較（Node.js / PHP / Python）

### 行程1: JSONL 読み込み
- Node.js:
  - `fs.readFileSync` + 改行分割 + `JSON.parse` を手続き的に実装。
- PHP:
  - `file()` + 行ごとの `json_decode` で配列へ変換。
- Python:
  - JSONL を読み込んだ後 `pandas.json_normalize()` で DataFrame 化。
- Python が得意な点:
  - 読み込み直後に列単位前処理へ連続接続できる。

### 行程2: 型変換
- Node.js:
  - 日時と数値の判定・変換を明示関数で実装。
- PHP:
  - `DateTimeImmutable` と `is_numeric` で変換。
- Python:
  - `pd.to_datetime(errors="coerce", utc=True)` と `pd.to_numeric(errors="coerce")` を列単位で実施。
- Python が得意な点:
  - 変換失敗時の扱い（NaN/NaT）を一貫して後段処理に接続しやすい。

### 行程3: 欠損補完
- Node.js:
  - ループで null/空文字を判定して補完。
- PHP:
  - foreach で欠損判定して補完。
- Python:
  - マスク（`isna`）で欠損件数集計と補完を実施。
- Python が得意な点:
  - 欠損件数の集計と補完更新を同じ式で追跡しやすい。

### 行程4: 外れ値検出（IQR）
- Node.js:
  - 分位点計算（線形補間）を関数として手実装。
- PHP:
  - 分位点計算（線形補間）を関数として手実装。
- Python:
  - `quantile(0.25/0.75)` で分位点を算出し、列演算で外れ値を判定。
- Python が得意な点:
  - 統計処理を低コードで記述でき、判定ロジックの意図が読み取りやすい。

### 行程5: 出力整形
- Node.js:
  - ソート後に JSON オブジェクトを手組み。
- PHP:
  - `usort` + 配列整形で JSON へ変換。
- Python:
  - DataFrame から辞書配列へ変換し、JSON へ出力。
- Python が得意な点:
  - 中間データ（DataFrame）をそのまま検証しやすく、再整形の拡張が容易。

## 6. 出力結果（主要値）

- `summary`
  - `total_records`: 10
  - `filled_response_time_count`: 2
  - `filled_status_count`: 1
  - `filled_endpoint_count`: 1
  - `filled_method_count`: 1
  - `outlier_count`: 1
- `response_time_bounds`
  - `lower`: 86.25
  - `upper`: 130.25
- `outliers`
  - `timestamp=2026-02-10T10:07:00Z`, `endpoint=/api/payments`, `response_time_ms=1000`

## 7. 品質チェック結果

- `docker compose run --rm --no-deps app ruff check app` -> `All checks passed!`
- `docker compose run --rm --no-deps app mypy` -> `Success: no issues found in 7 source files`

## 8. 実装コード量（参考）

- Python: `199` 行（`app/data_processing/log_preprocessing.py`）
- Node.js: `225` 行（`comparisons/topic2/log_preprocessing_node.js`）
- PHP: `228` 行（`comparisons/topic2/log_preprocessing_php.php`）

## 9. 完了判定

以下を満たしたため、お題2を完了とする。

1. Python / Node.js / PHP で同一入力に対する出力一致を確認した。
2. 欠損補完・型変換・IQR外れ値判定を3言語で比較できる実装を揃えた。
3. 実行手順と期待値比較手順を `README.md` に追記した。
4. `ruff` / `mypy` の品質チェックを通過した。
