# 作業報告書

- 作成日時: 2026-02-21 18:21:32
- 対象プロジェクト: `python-learning`
- 報告範囲: お題2（JSONログ整形・異常値チェック・外れ値検出）の実装確定版

## 1. 実施サマリ

同一の JSON Lines 入力 (`data/api_logs_sample.jsonl`) に対して、`Python` / `Node.js` / `PHP` の3実装を揃え、
以下の二段構えで処理する仕様に確定した。

1. 異常値チェック（業務ルール）
2. 外れ値検出（統計ルール: IQR）

あわせて、お題1と同じ学習粒度になるよう、3実装すべてに日本語コメントを強化した。

## 2. 用語整理（今回確定した定義）

- 異常値（anomaly）:
  - 業務上・論理上あり得ない値。
  - 例: `response_time_ms < 0`、`status` が `0` でも `100-599` でもない。
- 外れ値（outlier）:
  - データ分布上で極端に離れた値。
  - 判定は IQR 法（`[Q1 - 1.5*IQR, Q3 + 1.5*IQR]` の外側）。

## 3. 追加・更新ファイル（最終）

1. 実装
- `app/data_processing/log_preprocessing.py`
- `comparisons/topic2/log_preprocessing_node.js`
- `comparisons/topic2/log_preprocessing_php.php`

2. データ
- `data/api_logs_sample.jsonl`
- `data/api_logs_expected.json`

3. 既存資料
- 既存のお題2報告書は初版として残し、本報告書を完成版とする。

## 4. 共通仕様（I/F）

- 入力: `--input data/api_logs_sample.jsonl`
- 出力キー:
  - `summary`
  - `response_time_bounds`
  - `cleaned_logs`
  - `anomalies`
  - `outliers`

### 4.1 欠損補完ルール（3言語共通）
- `response_time_ms`: 中央値で補完
- `status`: `0` で補完
- `endpoint`: `"/unknown"` で補完
- `method`: `"UNKNOWN"` で補完

### 4.2 異常値チェック（業務ルール）
- `response_time_ms < 0`
- `status != 0` かつ `status < 100 または status > 599`

### 4.3 外れ値検出（統計ルール）
- IQR 法（`lower = Q1 - 1.5*IQR`, `upper = Q3 + 1.5*IQR`）

## 5. 行程別比較（Node.js / PHP / Python）

### 行程1: JSONL 読み込み
- Node.js:
  - `fs.readFileSync` + 改行分割 + `JSON.parse`。
- PHP:
  - `file()` + 行ごとの `json_decode`。
- Python:
  - JSONL 読み込み後に `pandas.json_normalize()` で DataFrame 化。
- Python が得意な点:
  - 読み込み直後に列演算へ接続しやすい。

### 行程2: 型変換
- Node.js:
  - `Date` / 数値変換関数を行ループで適用。
- PHP:
  - `DateTimeImmutable` + `is_numeric`。
- Python:
  - `to_datetime(..., errors="coerce")` と `to_numeric(..., errors="coerce")`。
- Python が得意な点:
  - 失敗値を NaT/NaN へ統一し、後続補完へ自然につなげられる。

### 行程3: 欠損補完
- Node.js:
  - ループで欠損判定・補完・件数加算。
- PHP:
  - foreach で欠損判定・補完・件数加算。
- Python:
  - マスク演算で欠損件数集計と補完を一括実施。
- Python が得意な点:
  - 条件、件数、更新が同じ列コンテキストで追える。

### 行程4: 異常値チェック（業務ルール）
- Node.js:
  - 条件式を各行へ適用して `is_anomaly` を付与。
- PHP:
  - 条件式を各行へ適用して `is_anomaly` を付与。
- Python:
  - 列演算で `is_anomaly` を一括付与。
- Python が得意な点:
  - 業務ルールをブール列で可視化しやすく、後続集計へ直結できる。

### 行程5: 外れ値検出（IQR）
- Node.js:
  - 線形補間の分位点関数を実装し IQR 判定。
- PHP:
  - 線形補間の分位点関数を実装し IQR 判定。
- Python:
  - `quantile(0.25/0.75)` + 列条件で IQR 判定。
- Python が得意な点:
  - 統計判定の式を短く保ちつつ意味を維持できる。

### 行程6: 出力整形
- Node.js:
  - 昇順ソート + JSONオブジェクト組み立て。
- PHP:
  - `usort` + 配列整形 + JSON化。
- Python:
  - DataFrame から辞書配列へ変換し JSON化。
- Python が得意な点:
  - 中間DataFrameの検証と出力整形の往復がしやすい。

## 6. 返却スキーマの宣言位置

- Python:
  - `CleanedLogItem`, `Summary`, `ResponseTimeBounds`, `LogPreprocessResult` を TypedDict で宣言。
- Node.js:
  - `preprocessLogs` の JSDoc 戻り値型でスキーマを宣言。
- PHP:
  - `preprocess_logs` の最終 `return` 配列構造を実質スキーマとして扱う。

## 7. 出力結果（現サンプル）

- `summary`
  - `total_records`: 10
  - `filled_response_time_count`: 2
  - `filled_status_count`: 1
  - `filled_endpoint_count`: 1
  - `filled_method_count`: 1
  - `anomaly_count`: 0
  - `outlier_count`: 1
- `response_time_bounds`
  - `lower`: 86.25
  - `upper`: 130.25
- `anomalies`
  - `[]`
- `outliers`
  - `timestamp=2026-02-10T10:07:00Z`, `endpoint=/api/payments`, `response_time_ms=1000`

## 8. 実行コマンド（Docker 経由）

1. Python
```bash
docker compose run --rm --no-deps app python -m app.data_processing.log_preprocessing --input data/api_logs_sample.jsonl
```

2. Node.js
```bash
docker run --rm -v "$PWD":/workspace -w /workspace node:20 node comparisons/topic2/log_preprocessing_node.js --input data/api_logs_sample.jsonl
```

3. PHP
```bash
docker run --rm -v "$PWD":/workspace -w /workspace php:8.3-cli php comparisons/topic2/log_preprocessing_php.php --input data/api_logs_sample.jsonl
```

4. 一致検証
```bash
diff -u <(jq -S . data/api_logs_expected.json) <(jq -S . /tmp/logs_py.json)
diff -u <(jq -S . data/api_logs_expected.json) <(jq -S . /tmp/logs_node.json)
diff -u <(jq -S . data/api_logs_expected.json) <(jq -S . /tmp/logs_php.json)
```

## 9. 品質チェック結果

- `docker compose run --rm --no-deps app ruff check app` -> `All checks passed!`
- `docker compose run --rm --no-deps app mypy` -> `Success: no issues found in 7 source files`

## 10. 実装コード量（参考）

- Python: `284` 行（`app/data_processing/log_preprocessing.py`）
- Node.js: `274` 行（`comparisons/topic2/log_preprocessing_node.js`）
- PHP: `276` 行（`comparisons/topic2/log_preprocessing_php.php`）

## 11. お題2 完了判定（最終）

以下を満たしたため、お題2は完成とする。

1. 3言語で同一I/F・同一出力を維持した。
2. 「異常値チェック（業務ルール）」と「外れ値検出（IQR）」を分離した。
3. 返却スキーマの意味と宣言場所を、コードコメントと報告書の両方で明示した。
4. `ruff` / `mypy` / 期待値比較（diff）を通過した。
