# 作業報告書

- 作成日時: 2026-02-21 21:51:28
- 対象プロジェクト: `python-learning`
- 報告範囲: お題5（可視化によるレポート化）の開始・実装・検証

## 1. 実施サマリ

お題4までで確立した「同一I/F・同一JSONスキーマ・3言語比較」の方針を継続し、
お題5として「CSV集計 -> グラフ出力 -> 意思決定向けMarkdown出力」を `Python` / `Node.js` / `PHP` で実装した。

Python は `pandas + matplotlib`、Node.js/PHP は学習用に手続きSVG生成で実装し、
最終JSON（サマリ・集計値・示唆・生成物メタ情報）は3言語で一致することを確認した。

## 2. 追加・更新ファイル

1. 実装
- `app/data_processing/visual_sales_report.py`
- `comparisons/topic5/visual_sales_report_node.js`
- `comparisons/topic5/visual_sales_report_php.php`

2. 期待値データ
- `data/topic5_visual_report_expected.json`

3. 依存・手順
- `requirements.txt`
  - `matplotlib==3.10.6` を追加
- `README.md`
  - お題5の実行コマンドと期待値比較手順を追記

## 3. 共通仕様（I/F）

- 入力:
  - `--input data/sales_sample.csv`
  - `--output-dir <可視化出力先>`
- 出力キー:
  - `summary`
  - `daily_sales`
  - `category_sales`
  - `top_products`
  - `insights`
  - `artifacts`

### 3.1 集計・可視化ルール
- `line_total = quantity * price`
- `daily_sales`: 日付ごとの売上合計（昇順）
- `category_sales`: カテゴリ売上（売上降順）
- `top_products`: 商品売上Top3（売上降順）
- `insights`: 意思決定向け短文3件（最大売上日 / 最大カテゴリ / 最大商品）
- `artifacts`: 生成ファイル名（`daily_sales.svg`, `category_sales.svg`, `top_products.svg`, `decision_report.md`）

## 4. 行程別比較（Node.js / PHP / Python）

### 行程1: 入力読み込み・集計
- Node.js:
  - CSVを行分割して `Map` で日次・カテゴリ・商品を手集計。
- PHP:
  - `fgetcsv` + 連想配列で日次・カテゴリ・商品を手集計。
- Python:
  - `pandas.read_csv()` + `groupby/agg/sort_values` で宣言的に集計。
- Python が得意な点:
  - 集計軸を追加しても `groupby` 記述の差分が小さく、前処理から可視化まで接続しやすい。

### 行程2: 可視化出力
- Node.js:
  - SVG文字列を組み立てて棒グラフ/折れ線グラフを出力。
- PHP:
  - SVG文字列を組み立てて棒グラフ/折れ線グラフを出力。
- Python:
  - `matplotlib` で折れ線・棒・横棒を描画し `savefig(..., format="svg")`。
- Python が得意な点:
  - 可視化APIが豊富で、見た目調整・グラフ種類の変更をライブラリ呼び出しで対応しやすい。

### 行程3: レポート化
- Node.js:
  - 文字列配列でMarkdownを構成して書き出し。
- PHP:
  - 文字列配列でMarkdownを構成して書き出し。
- Python:
  - 集計結果と可視化生成物をそのままMarkdownへ埋め込み。
- Python が得意な点:
  - DataFrame結果と可視化結果を同一コード内で扱えるため、分析->報告の往復が短い。

## 5. 実行コマンド（Docker 経由）

1. Python
```bash
docker compose run --rm --no-deps app python -m app.data_processing.visual_sales_report \
  --input data/sales_sample.csv \
  --output-dir data/topic5_artifacts/python \
  > /tmp/topic5_py.json
```

2. Node.js
```bash
docker run --rm -v "$PWD":/workspace -w /workspace node:20 \
  node comparisons/topic5/visual_sales_report_node.js \
  --input data/sales_sample.csv \
  --output-dir data/topic5_artifacts/node \
  > /tmp/topic5_node.json
```

3. PHP
```bash
docker run --rm -v "$PWD":/workspace -w /workspace php:8.3-cli \
  php comparisons/topic5/visual_sales_report_php.php \
  --input data/sales_sample.csv \
  --output-dir data/topic5_artifacts/php \
  > /tmp/topic5_php.json
```

4. 一致検証
```bash
diff -u <(jq -S . data/topic5_visual_report_expected.json) <(jq -S . /tmp/topic5_py.json)
diff -u <(jq -S . data/topic5_visual_report_expected.json) <(jq -S . /tmp/topic5_node.json)
diff -u <(jq -S . data/topic5_visual_report_expected.json) <(jq -S . /tmp/topic5_php.json)
```

## 6. 検証結果

- 3言語とも `data/topic5_visual_report_expected.json` と差分なし。
- `summary`:
  - `total_orders`: 9
  - `total_revenue`: 60
  - `average_order_value`: 6.67
  - `best_sales_day`: `2026-02-01`
  - `best_sales_amount`: 25

- 生成物（各言語ごと）:
  - `daily_sales.svg`
  - `category_sales.svg`
  - `top_products.svg`
  - `decision_report.md`

## 7. 品質チェック

- `docker compose run --rm --no-deps app ruff check app` -> `All checks passed!`
- `docker compose run --rm --no-deps app mypy app` -> `Success: no issues found in 10 source files`

## 8. お題5の注目ポイント（次回レビュー用）

1. 集計から可視化までの一気通貫性
- Node.js / PHP は「集計ロジック」と「SVG組み立てロジック」を明示的に分けて書く必要があり、処理量が増えるとコード分散が起きやすい。
- Python は `pandas` 集計結果をそのまま `matplotlib` に渡せるため、分析フローを短く保ちやすい。

2. 可視化仕様変更時の差分量
- 例: 棒グラフを横棒や積み上げへ変更する場合、Node.js / PHP はSVG座標計算の修正範囲が大きくなりやすい。
- Python は描画API呼び出しの変更で対応しやすく、試行回数が増える探索フェーズで有利。

3. 出力の再現性（diff検証の安定性）
- 3言語とも JSON の並び順を固定し、`diff` 比較が毎回安定する構成にした。
- グラフはビジュアル差分を目視確認、JSONは機械差分確認という役割分離を維持する。

4. レポート化の運用しやすさ
- `insights` と `decision_report.md` を同時出力することで、機械可読（JSON）と人間可読（Markdown）の両方を確保した。
- 将来の自動配信（定期バッチ）では、同じI/Fを維持したまま保存先や通知先だけ差し替えやすい。

5. Python学習として押さえる比較観点
- Node.js 観点: `Map` 集計 + 文字列生成をどう分離設計するか。
- PHP 観点: 連想配列集計 + ファイル出力の責務分離をどう保つか。
- Python 観点: `DataFrame` を中心に「集計・可視化・レポート」を同一データ構造でつなぐ設計が実務での強み。

## 9. お題5 開始時点の完了判定

以下を満たしたため、お題5を「開始実装完了（初版）」とする。

1. 可視化 + Markdownレポートの一連処理を3言語で実装した。
2. 同一I/F・同一JSONスキーマで比較可能な形に揃えた。
3. 期待値比較、lint、型チェックを通過した。
4. 各行程で Node.js / PHP / Python 比較と Python優位点を文書化した。
