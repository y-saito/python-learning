# 作業報告書

- 作成日時: 2026-02-21 15:14:17
- 対象プロジェクト: `python-learning`
- 報告範囲: お題1（CSV 売上データ集計）の実装・比較・検証

## 1. 実施サマリ

同一の CSV 入力 (`data/sales_sample.csv`) に対して、`Python` / `Node.js` / `PHP` の 3 実装を作成した。
各実装は共通 CLI I/F（`--input <csv_path>`）で動作し、同一 JSON スキーマ（`daily_sales`, `category_sales`, `top_products`）を出力する。

## 2. 追加・更新ファイル

1. 依存追加
- `requirements.txt`
  - `pandas==2.3.2` を追加。

2. データ定義
- `data/sales_sample.csv`
  - 比較用の固定サンプルデータ（小数価格、`quantity=0` を含む）を追加。
- `data/sales_expected.json`
  - 期待値（正解集計）を追加。

3. Python 実装（基準）
- `app/data_processing/sales_aggregation.py`
  - `pandas.read_csv()` + `groupby()` + `agg()` で集計。

4. Node.js 比較実装
- `comparisons/topic1/sales_aggregation_node.js`
  - CSV パース + `Map` + `reduce` 的集計で同等処理。

5. PHP 比較実装
- `comparisons/topic1/sales_aggregation_php.php`
  - `fgetcsv` + 配列ループで同等処理。

## 3. 共通仕様（I/F）

- 入力: `--input data/sales_sample.csv`
- 出力キー:
  - `daily_sales`
  - `category_sales`
  - `top_products`（売上降順 Top3）
- 金額ルール:
  - 小数第2位まで丸め
  - 丸め後に整数なら整数値として出力（`25.0` ではなく `25`）

## 4. 実行コマンド（Docker 経由）

1. Python
```bash
docker compose run --rm --no-deps app python -m app.data_processing.sales_aggregation --input data/sales_sample.csv
```

2. Node.js
```bash
docker run --rm -v "$PWD":/workspace -w /workspace node:20 node comparisons/topic1/sales_aggregation_node.js --input data/sales_sample.csv
```

3. PHP
```bash
docker run --rm -v "$PWD":/workspace -w /workspace php:8.3-cli php comparisons/topic1/sales_aggregation_php.php --input data/sales_sample.csv
```

## 5. 集計結果（3実装で一致）

```json
{
  "daily_sales": [
    {"date": "2026-02-01", "sales": 25},
    {"date": "2026-02-02", "sales": 14},
    {"date": "2026-02-03", "sales": 21}
  ],
  "category_sales": [
    {"category": "Food", "sales": 37.5},
    {"category": "Stationery", "sales": 22.5}
  ],
  "top_products": [
    {"product": "Coffee", "sales": 16, "quantity": 4},
    {"product": "Tea", "sales": 11, "quantity": 4},
    {"product": "Notebook", "sales": 10.5, "quantity": 3}
  ]
}
```

検証方法（JSON 正規化比較）:
```bash
diff -u <(jq -S . data/sales_expected.json) <(jq -S . /tmp/sales_py.json)
diff -u <(jq -S . data/sales_expected.json) <(jq -S . /tmp/sales_node.json)
diff -u <(jq -S . data/sales_expected.json) <(jq -S . /tmp/sales_php.json)
```
すべて差分なし（exit code 0）。

## 6. 行程別比較（Node.js / PHP / Python）

### 行程1: CSV 読み込み
- Node.js:
  - 文字列読み込み後に分割・型変換を手続き的に記述。
- PHP:
  - `fgetcsv` で1行ずつ読み、都度キャスト。
- Python:
  - `pandas.read_csv()` で型付きテーブルとして取り込む。
- Python が得意な点:
  - 読み込み直後に列演算・集計へ自然に接続でき、前処理の追加が容易。

### 行程2: 集計（日次・カテゴリ・商品Top）
- Node.js:
  - `Map` の更新ロジックを手実装。
- PHP:
  - 連想配列の存在確認と加算を手実装。
- Python:
  - `groupby` / `agg` / `sort_values` を宣言的に記述。
- Python が得意な点:
  - 「何を集計するか」を中心に書けるため、ロジックの見通しが良い。

### 行程3: 出力整形（JSON スキーマ固定）
- Node.js:
  - 配列変換とソート条件を明示実装。
- PHP:
  - 配列組み立て + `usort` で明示実装。
- Python:
  - DataFrame から辞書配列へ変換して整形。
- Python が得意な点:
  - 集計結果の再利用・再整形がしやすく、列追加にも強い。

### 行程4: 検証
- Node.js/PHP/Python 共通で同一データ・同一期待値比較を実施。
- Python が得意な点:
  - 将来、`pytest` + `pandas.testing` による自動検証へ発展させやすい。

## 7. 比較観点の結果（お題1時点）

- 実装コード量（行数）
  - Python: 71 行
  - Node.js: 77 行
  - PHP: 104 行
- 可読性
  - Python は `groupby/agg` により意図（集計軸）が直接読める。
- 拡張性
  - Python は列追加・新規集計軸の追加時に変更範囲が小さく済む。

## 8. 次工程への接続

次回のお題2（JSONログ整形・異常値検出）でも、今回と同じ比較フォーマットを維持する。
- Node.js でのやり方
- PHP でのやり方
- Python でのやり方
- Python が得意な理由

## 9. 追記（お題1完了までに実施した改善）

### 9.1 コード品質基盤の導入（Formatter / Linter / Typecheck）

1. 追加したツール
- Python:
  - `ruff`（Formatter + Linter）
  - `mypy`（Typecheck）
  - `pandas-stubs`（pandas 型情報）

2. 追加・更新ファイル
- `pyproject.toml`
  - `ruff` / `mypy` 設定を追加。
- `requirements.txt`
  - `ruff`, `mypy`, `pandas-stubs` を追加。
- `README.md`
  - Docker 経由での Formatter/Linter/Typecheck 実行手順を追記。
- `app/__init__.py`
- `app/core/__init__.py`
- `app/data_processing/__init__.py`
  - パッケージ解決を安定させるため追加。

3. 比較（Node.js / PHP / Python）
- Node.js:
  - `prettier` + `eslint` + `tsc` が一般的。
- PHP:
  - `php-cs-fixer` + `phpstan` / `psalm` が一般的。
- Python（今回導入）:
  - `ruff format` + `ruff check` + `mypy`。

4. 検証結果
- `docker compose run --rm --no-deps app ruff check app` -> `All checks passed!`
- `docker compose run --rm --no-deps app mypy` -> `Success: no issues found in 6 source files`

### 9.2 コメント・ドキュメント整備

1. 実施内容
- お題1関連の3実装（Python / Node.js / PHP）に詳細コメントを追記。
- 関数単位のドキュメントを追加。
  - Python: docstring
  - Node.js: JSDoc
  - PHP: PHPDoc
- すべて日本語で統一。

2. 比較（Node.js / PHP / Python）
- Node.js:
  - JSDoc が TypeScript なしでも仕様共有に有効。
- PHP:
  - PHPDoc が静的解析とIDE補完に有効。
- Python:
  - docstring は `__doc__` で参照可能で、mypyや開発者向け文書の基盤になる。

### 9.3 DataFrame デバッグ機能の追加

1. 実施内容
- `app/data_processing/sales_aggregation.py` に `--debug-dataframe` を追加。
- JSON 出力前に、以下の中間状態を確認できるようにした。
  - `line_total` 追加後の元DataFrame
  - `daily_df`
  - `category_df`
  - `product_df`

2. ログ出力方式
- 初期実装は `print` で出力。
- その後、実務寄りに `logging`（標準ライブラリ）へ置換。
  - `--debug-dataframe` 指定時のみ `DEBUG` レベルを有効化。

3. 比較（Node.js / PHP / Python）
- Node.js:
  - 学習段階は `console.log`、実務は構造化ログ（例: pino）。
- PHP:
  - 学習段階は `var_dump/print_r`、実務は Monolog 系。
- Python:
  - 学習段階は `print`、実務は `logging`。
  - 今回は実務に寄せて `logging` を採用。

## 10. お題1で得た知見（最終）

1. データ構造の差分
- Python:
  - `pandas.read_csv()` で即 `DataFrame` 化できる。
  - CSV取り込み後すぐに列演算・集計へ接続できる点が強い。
- Node.js / PHP:
  - 配列/Map/連想配列を手で組み立てる工程が増える。

2. デバッグ容易性の差分
- Python:
  - DataFrame をそのまま表形式で確認できるため、JSON化直前の状態把握がしやすい。
- Node.js / PHP:
  - `console.log` / `var_dump` による確認は可能だが、表形式の一貫した操作基盤は別途整備が必要。

3. 品質担保の差分
- 3言語とも Formatter/Linter/Typecheck の組み合わせは必要。
- Python は `ruff + mypy + stubs` を早期導入することで、学習段階でも品質を維持しやすい。

## 11. お題1完了判定

以下を満たしたため、お題1を完了とする。

1. 固定サンプルCSVで Python / Node.js / PHP の出力一致を確認した。
2. 3実装の比較（コード量・可読性・拡張性）を記録した。
3. デバッグ観点（中間DataFrame確認・ログ方式比較）を追加した。
4. Formatter / Linter / Typecheck を導入し、チェック通過を確認した。
