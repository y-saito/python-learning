# 作業報告書

- 作成日時: 2026-02-21 22:42:13
- 対象プロジェクト: `python-learning`
- 報告範囲: お題7（ETLミニパイプライン）の実装・比較・検証

## 1. 実施サマリ

`orders` 生データを対象に、`Extract -> Transform -> Load` を明示した ETL を `Python` / `Node.js` / `PHP` の3実装で追加した。
3実装は共通CLI（`--input`, `--output`, `--debug`）で実行でき、同一JSONスキーマ（`summary`, `sample_cleaned_rows`）を返す。

## 2. 追加・更新ファイル

1. 実装
- `app/data_processing/etl_pipeline.py`
- `comparisons/topic7/etl_pipeline_node.js`
- `comparisons/topic7/etl_pipeline_php.php`

2. データ
- `data/topic7_orders_raw.csv`
- `data/topic7_etl_expected.json`

3. ドキュメント
- `README.md`
  - お題7の実行コマンドと期待値比較コマンドを追記

## 3. 共通仕様（I/F）

- 入力:
  - `--input data/topic7_orders_raw.csv`
  - `--output data/tmp/topic7_clean_orders.parquet`
  - `--debug`（中間データを標準エラー出力）
- 出力キー:
  - `summary.extract`
  - `summary.transform`
  - `summary.load`
  - `summary.total_sales`
  - `sample_cleaned_rows`

## 4. 行程別比較（Node.js / PHP / Python）

### 行程1: Extract（CSV読込）
- Node.js:
  - `fs.readFileSync` + 行分割で配列化。
- PHP:
  - `fgetcsv` で行ループし連想配列化。
- Python:
  - `pandas.read_csv(dtype=str)` で DataFrame に一括読込。
- Python が得意な点:
  - 読込直後から列単位操作に移れるため、Transform への接続が短い。

### 行程2: Transform（型変換・欠損補完・派生列）
- Node.js:
  - 日付/数値のパース可否を行ループで判定し、中央値補完を適用。
- PHP:
  - `strtotime`・`is_numeric` 判定を `foreach` で適用し、同様に中央値補完。
- Python:
  - `to_datetime(errors='coerce')` + マスク演算 + 列代入で一括変換。
- Python が得意な点:
  - 欠損・不正値処理を列単位で宣言的に記述でき、件数計測も同時に書きやすい。

### 行程3: Load（Parquet保存）
- Node.js:
  - `parquetjs-lite` でスキーマ定義後、`appendRow` で保存。
- PHP:
  - `codename/parquet` で `Schema` / `DataColumn` を作成して保存。
- Python:
  - `DataFrame.to_parquet(compression=None)` で保存。
- Python が得意な点:
  - DataFrame から直接保存できるため、Load工程の実装量が最小になりやすい。

## 5. 検証コマンド

1. Python
```bash
docker compose run --rm --no-deps app python -m app.data_processing.etl_pipeline \
  --input data/topic7_orders_raw.csv \
  --output data/tmp/topic7_clean_orders.parquet \
  > /tmp/topic7_py.json
```

2. Node.js
```bash
docker run --rm -v "$PWD":/workspace -w /workspace node:20 sh -lc \
  "cd /tmp && npm init -y >/dev/null && npm install parquetjs-lite@0.8.7 >/dev/null && \
   NODE_PATH=/tmp/node_modules node /workspace/comparisons/topic7/etl_pipeline_node.js \
     --input /workspace/data/topic7_orders_raw.csv \
     --output /workspace/data/tmp/topic7_clean_orders.parquet" \
  > /tmp/topic7_node.json
```

3. PHP
```bash
docker run --rm -v "$PWD":/workspace -w /workspace php:8.3-cli bash -lc \
  "apt-get update >/dev/null && apt-get install -y --no-install-recommends curl git unzip libgmp-dev >/dev/null && \
   docker-php-ext-install -j\$(nproc) gmp bcmath >/dev/null && \
   mkdir -p /tmp/topic7_php_vendor && cd /tmp/topic7_php_vendor && \
   printf '{\"name\":\"topic7/parquet\",\"require\":{}}' > composer.json && \
   curl -sS https://getcomposer.org/installer | php >/dev/null && \
   php composer.phar require codename/parquet:^0.7.2 --no-interaction >/dev/null && \
   PARQUET_VENDOR_AUTOLOAD=/tmp/topic7_php_vendor/vendor/autoload.php \
   php /workspace/comparisons/topic7/etl_pipeline_php.php \
     --input /workspace/data/topic7_orders_raw.csv \
     --output /workspace/data/tmp/topic7_clean_orders.parquet" \
  > /tmp/topic7_php.json
```

4. 期待値比較
```bash
diff -u <(jq -S . data/topic7_etl_expected.json) <(jq -S . /tmp/topic7_py.json)
diff -u <(jq -S . data/topic7_etl_expected.json) <(jq -S . /tmp/topic7_node.json)
diff -u <(jq -S . data/topic7_etl_expected.json) <(jq -S . /tmp/topic7_php.json)
```

## 6. 検証結果

- 3言語すべて `data/topic7_etl_expected.json` と差分なし。
- 期待値サマリ:
  - `input_records`: 8
  - `transformed_records`: 7
  - `dropped_invalid_order_date_count`: 1
  - `filled_customer_id_count`: 1
  - `filled_quantity_count`: 3
  - `filled_unit_price_count`: 2
  - `total_sales`: 1231.1

## 7. お題7 完了判定

以下を満たしたため、お題7を完了とする。

1. 3言語で ETL の3段階（Extract/Transform/Load）を同一要件で実装した。
2. 3言語で同一CLI・同一JSONスキーマを提供した。
3. Parquet出力まで含めて期待値比較で一致を確認した。

## 8. 学習時に見るべきポイント

1. Extract の差
- Node.js/PHP は「1行ずつ読む」実装が中心。
- Python は `pandas.read_csv` で最初から表形式（DataFrame）に乗る。
- 見るべき点: 読み込み直後に、どこまで次工程へ直結できるか。

2. Transform の差
- Node.js/PHP は `if` 分岐を行ループで積み上げる実装になりやすい。
- Python は「列単位の変換・補完」をまとめて記述できる。
- 見るべき点: 欠損補完ルール追加時に、どの言語が変更箇所を最小化できるか。

3. Load（Parquet保存）の差
- Node.js/PHP は Parquet スキーマ・列定義を明示するコードが必要。
- Python は `to_parquet` で保存まで短い。
- 見るべき点: ETL後半での実装量と、保存形式変更時の追従コスト。

4. 検証しやすさの差
- 3言語とも期待値 `data/topic7_etl_expected.json` で diff 検証可能。
- 見るべき点: 「実装が動くか」ではなく「同一仕様を再現できるか」を確認すること。

5. 実務へ繋げる次の観点
- 例外時のリトライ、再実行時の冪等性、処理ログの永続化を追加できるか。
- 見るべき点: 学習用スクリプトをバッチ運用へ拡張する際の設計余地。
